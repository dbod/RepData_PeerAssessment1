---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---

```{r, results="hide"}
library(ggplot2)
library(lattice)
library(dplyr)
library(lubridate)
```


## Loading and preprocessing the data
The data analysed are described in the csv file `data/activity.csv`. The dataset 
contains three columns :

* date : date of the measurement  
* interval : identifier for the 5 minutes interval in which the measurement was taken  
* steps : the number of steps for that date and that interval  

The date is trabsformed from a string to a date class.  
The result is saved as the `activities` dataframe.
```{r, echo=TRUE}
activities <- read.csv("data/activity.csv") %>%
  mutate(date = as.Date(date))
print(str(activities))
print(summary(activities))
```

## What is mean total number of steps taken per day?
We build a new dataframe from the _activities_ cleaned from all the missing values.  
The new dataframe contains two columns :

* date : the day in which the measurements are taken  
* steps : the total number of steps for that day  

```{r, echo=TRUE}
steps_per_day <- activities[complete.cases(activities),] %>% 
  select(date, steps) %>%
  group_by(date) %>%
  summarise(steps = sum(steps))
```

The results are shown in the following history plot.  
```{r, echo=TRUE}
p <- ggplot(steps_per_day, aes(date, steps)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Number of steps per day") +
    xlab("Date") + 
    ylab("Number of steps")
p
```

```{r, echo=TRUE}
mean_steps <- format(mean(steps_per_day$steps), scientific=FALSE)
median_steps <- median(steps_per_day$steps)
```
The mean of steps per day is **`r mean_steps`** and the median is **`r median_steps`**.

## What is the average daily activity pattern?

We build a new dataframe describing the average steps per interval. From that dataframe, we can get the optimized interval for the number of steps per day.

```{r, echo=TRUE}
average_steps_per_interval <- activities[complete.cases(activities),] %>% 
  select(interval, steps) %>%
  group_by(interval) %>%
  summarise(steps = mean(steps))
max_interval = average_steps_per_interval %>%
  filter(steps >= max(steps))
```


```{r, echo=TRUE}
p <- ggplot(average_steps_per_interval, aes(interval, steps)) +
    geom_line(linetype = "solid") +
    ggtitle("Average number of steps per interval") +
    xlab("Interval") + 
    ylab("Number of steps") +
    geom_segment(aes(x = max_interval$interval[1]+100, y = max_interval$steps[1], 
                     xend = max_interval$interval[1], yend = max_interval$steps[1]),
                  arrow = arrow(length = unit(0.2, "cm"))) +
    geom_text(aes(x = max_interval$interval[1] + 350, y = max_interval$steps[1]), 
              label = paste0("(", max_interval$interval[1], " , ", 
                             format(max_interval$steps[1], scientific = FALSE), ")"), 
              color = "red")
p
```

The interval **`r max_interval$interval[1]`** gives the maximum value of steps 
for all days with an average value of **`r format(max_interval$steps[1], scientific=FALSE)`**.

## Imputing missing values

```{r, echo=TRUE}
number_NA_values = count(activities[is.na(activities),])[1, 1]
```

We have `r number_NA_values` missing values in the original dataframe of activities.  
We build a new dataframe from activities by replacing the missing values with the 
median value of the corresponding interval.

```{r, echo=TRUE}
activities_no_missing <- activities %>% 
  group_by(interval) %>% 
  mutate(avg.Interval = median(steps, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(date) %>%
  mutate(steps = ifelse(is.na(steps), avg.Interval, steps)) %>%
  ungroup() %>%
  select(date, interval, steps)
```

```{r, echo=TRUE}
steps_per_day_with_missing <- activities_no_missing %>% 
  select(date, steps) %>%
  group_by(date) %>%
  summarise(steps = sum(steps))
```

```{r, echo=TRUE}
p <- ggplot(steps_per_day_with_missing, aes(date, steps)) +
    geom_bar(stat="identity", na.rm = TRUE) +
    ggtitle("Number of steps per day\n(missing values are replaced with mean of interval)") +
    xlab("Date") + 
    ylab("Number of steps")
p
```

```{r, echo=TRUE}
mean_steps_with_missing <- format(mean(steps_per_day_with_missing$steps), scientific=FALSE)
median_steps_with_missing <- format(median(steps_per_day_with_missing$steps), scientific = FALSE)
```
The mean of steps per day is **`r mean_steps_with_missing`** and the median is 
**`r median_steps_with_missing`**.


## Are there differences in activity patterns between weekdays and weekends?

We create a new dataframe from the activities with missing values estimated and 
a new column :

- day : factor that can tkae the values weekday or weekend

```{r, echo=TRUE}
activities_days <- activities_no_missing %>% 
  mutate(day = ifelse(wday(date) %in% c(1,7), "weekend", "weekday"))
activities_days$day <- as.factor(activities_days$day)
mean_steps_per_interval_day <- distinct(activities_days %>% 
  group_by(interval, day) %>% 
  mutate(steps = mean(steps)) %>% 
  ungroup() %>%
  select(interval, steps, day))
```


```{r, echo=TRUE}
xyplot(steps~interval | day, 
       data = mean_steps_per_interval_day, 
       layout = c(1,2), 
       ylab = "Number of steps", 
       xlab = "Interval", 
       type = 'l',
       main = "Average number of steps per interval in weekend and weekday")
```


