---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---

```{r, results="hide"}
library(ggplot2)
library(lattice)
library(dplyr)
library(lubridate)
```


## Loading and preprocessing the data
The data analysed are described in the csv file `data/activity.csv`. These data are 
loaded in the dataset _activities_.

Three variables are described in _activities_ : 

- date [Date] : date of the measurement in the format "yyyy/MM/dd"  
- interval [int] : identifier for the 5 minutes interval in which the measurement was taken  
- steps [int] : the number of steps for that date and that interval  

```{r, echo=TRUE}
activities <- read.csv("data/activity.csv") %>%
  mutate(date = as.Date(date))

print(str(activities))
print(summary(activities))
```

## What is mean total number of steps taken per day?
A new dataframe, _steps_per_day_, is created from _activities_. This dataframe 
contains two variables :

- date [Date] : the day in which the measurements was taken  
- steps [int] : the total number of steps for that day  

_steps_per_day_ is cleaned from all missing values in _activities_.

```{r, echo=TRUE}
steps_per_day <- activities[complete.cases(activities),] %>% 
  select(date, steps) %>%
  group_by(date) %>%
  summarise(steps = sum(steps))
```

The results are shown in the following history plot. A binwith of 2000 steps is chosen.  
```{r, echo=TRUE}
p <- ggplot(steps_per_day, aes(steps)) +
    geom_histogram(binwidth = 2000, color="black", fill="darkred", alpha = 0.5) +
    ggtitle("Number of steps per day") +
    xlab("Number of steps") + 
    ylab("Frequency")
p
```


```{r, echo=TRUE}
mean_steps <- format(mean(steps_per_day$steps), scientific=FALSE)
median_steps <- format(median(steps_per_day$steps), scientific=FALSE)
```
The mean of steps per day is **`r mean_steps`** and the median is **`r median_steps`**.

## What is the average daily activity pattern?
The dataframe _average_steps_per_interval_ is created from _activities_ (cleaned 
from its missing values) : 

- interval [int] : identifier for the 5 minutes interval in which the measurement was taken 
- steps [int] : the mean value of steps for that interval

```{r, echo=TRUE}
average_steps_per_interval <- activities[complete.cases(activities),] %>% 
  select(interval, steps) %>%
  group_by(interval) %>%
  summarise(steps = mean(steps))
```

The dataframe is shown in a line graph below, showing the maximum value.
```{r, echo=TRUE}
max_interval = average_steps_per_interval %>%
  filter(steps >= max(steps))

p <- ggplot(average_steps_per_interval, aes(interval, steps)) +
    geom_line(linetype = "solid") +
    ggtitle("Average number of steps per interval") +
    xlab("Interval") + 
    ylab("Number of steps") +
    geom_segment(aes(x = max_interval$interval[1]+100, y = max_interval$steps[1], 
                     xend = max_interval$interval[1], yend = max_interval$steps[1]),
                  arrow = arrow(length = unit(0.2, "cm"))) +
    geom_text(aes(x = max_interval$interval[1] + 350, y = max_interval$steps[1]), 
              label = paste0("(", max_interval$interval[1], " , ", 
                             format(max_interval$steps[1], scientific = FALSE), ")"), 
              color = "red")
p
```

The interval **`r max_interval$interval[1]`** gives the maximum value of steps 
for all days with an average value of **`r format(max_interval$steps[1], scientific=FALSE)`**.

## Imputing missing values

```{r, echo=TRUE}
number_NA_values = count(activities[is.na(activities),])[1, 1]
```

We have `r number_NA_values` missing values in _activities_, the original dataframe.  
The dataframe _activities_no_missing_ is created from _activities_ by replacing 
the missing values with the **mean value of the corresponding interval**.  

```{r, echo=TRUE}
activities_no_missing <- activities %>% 
  group_by(interval) %>% 
  mutate(avg.Interval = mean(steps, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(date) %>%
  mutate(steps = ifelse(is.na(steps), avg.Interval, steps)) %>%
  ungroup() %>%
  select(date, interval, steps)
```

The dataframe _steps_per_day_with_missing_ is built from _activities_no_missing_ :

- date [Date] : the day in which the measurements was taken  
- steps [int] : the total number of steps for that day  

```{r, echo=TRUE}
steps_per_day_with_missing <- activities_no_missing %>% 
  select(date, steps) %>%
  group_by(date) %>%
  summarise(steps = sum(steps))
```

The results are shown in the following history plot. A binwith of 2000 steps is chosen. 
```{r, echo=TRUE}
p <- ggplot(steps_per_day_with_missing, aes(steps)) +
    geom_histogram(binwidth = 2000, color="black", fill="darkred", alpha = 0.5) +
    ggtitle("Number of steps per day\n(missing values are replaced with mean of the interval)") +
    xlab("Number of steps") + 
    ylab("Frequency")
p
```


```{r, echo=TRUE}
mean_steps_with_missing <- format(mean(steps_per_day_with_missing$steps), scientific=FALSE)
median_steps_with_missing <- format(median(steps_per_day_with_missing$steps), scientific = FALSE)
```
The mean of steps per day is **`r mean_steps_with_missing`** and the median is 
**`r median_steps_with_missing`**.

## Are there differences in activity patterns between weekdays and weekends?
The dataframe _mean_steps_per_interval_day_ is created from _activities_no_missing_ :

- day [Factor] : weekday or weekend depending on the date 
- interval [int] : identifier for the 5 minutes interval in which the measurement was taken 
- steps [int] : the mean value of steps for that day and interval

```{r, echo=TRUE}
activities_days <- activities_no_missing %>% 
  mutate(day = ifelse(wday(date) %in% c(1,7), "weekend", "weekday"))
activities_days$day <- as.factor(activities_days$day)
mean_steps_per_interval_day <- distinct(activities_days %>% 
  group_by(interval, day) %>% 
  mutate(steps = mean(steps)) %>% 
  ungroup() %>%
  select(interval, steps, day))
```

The results are shown in the graph below :
```{r, echo=TRUE}
xyplot(steps~interval | day, 
       data = mean_steps_per_interval_day, 
       layout = c(1,2), 
       ylab = "Number of steps", 
       xlab = "Interval", 
       type = 'l',
       main = "Average number of steps per interval in weekend and weekday")
```

The number of steps is globally higher during the weekend compare to the rest of 
the week.

